

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Packaging smaller parallel jobs into one large &mdash; Sigma2 documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../../_static/sigma2.ico"/>
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> Sigma2/Metacenter documentation
          

          
            
            <img src="../../_static/logo.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">News</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://opslog.sigma2.no">Latest changes and events</a></li>
<li class="toctree-l1"><a class="reference external" href="https://www.sigma2.no/hardware-status">Hardware live status</a></li>
</ul>
<p class="caption"><span class="caption-text">Getting help</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../getting_help/support_line.html">Support line</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting_help/how_to_write_good_support_requests.html">Writing good support requests</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting_help/qa-sessions.html">Open Question &amp; Answer Sessions for All Users</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting_help/lost_forgotten_password.html">Lost or expiring password</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting_help/project_leader_support.html">Project leader support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting_help/advanced_user_support.html">Advanced User Support (AUS)</a></li>
</ul>
<p class="caption"><span class="caption-text">Getting started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../getting_started/applying_account.html">How do I get an HPC account?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting_started/applying_resources.html">Applying for computing and storage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting_started/training.html">Training material</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting_started/getting_started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting_started/editing_files.html">Editing files</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting_started/create_ssh_keys.html">SSH</a></li>
</ul>
<p class="caption"><span class="caption-text">Services</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../nird_archive/user-guide.html">Research data archive</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../nird_toolkit/overview.html">NIRD Toolkit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../services/easydmp-user-documentation.html">EasyDMP User Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting_help/course_resources.html">CRaaS - Course Resources as a Service</a></li>
</ul>
<p class="caption"><span class="caption-text">High-performance computing</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../hpc_machines/hardware_overview.html">Overview over our machines</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../hpc_machines/betzy.html">Betzy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../hpc_machines/fram.html">Fram</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../hpc_machines/saga.html">Saga</a></li>
<li class="toctree-l1"><a class="reference external" href="https://hpc-uit.readthedocs.io">Stallo</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../hpc_machines/migration2metacenter.html">Migration to a Metacenter HPC machine</a></li>
<li class="toctree-l1"><a class="reference internal" href="../overview.html">Job types and job scripts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../code_development/overview.html">Code development</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../computing/tuning-applications.html">Tuning applications</a></li>
</ul>
<p class="caption"><span class="caption-text">Software</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../software/modulescheme.html">Software Module Scheme</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../software/installed_software.html">Installed Software</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../software/userinstallsw.html">Installing software as user</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../software/containers.html">Running Singularity and Docker containers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../software/appguides.html">Application guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../software/licenses.html">Licenses and access policies</a></li>
</ul>
<p class="caption"><span class="caption-text">Files and Storage</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../files_storage/nird.html">NIRD - National Infrastructure for Research Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../files_storage/clusters.html">Storage areas on HPC clusters</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../files_storage/backup.html">Backup on Betzy, Fram, Saga, and NIRD</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../files_storage/sharing_files.html">Data handling and storage policy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../files_storage/file_transfer.html">File transfer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../files_storage/performance.html">Storage performance tuning</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Sigma2/Metacenter documentation</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Packaging smaller parallel jobs into one large</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            
              <a href="https://github.com/UNINETTSigma2/documentation/blob/master/jobs/guides/running_job_steps_parallel.md" class="fa fa-github"> Edit on GitHub</a>
            
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="packaging-smaller-parallel-jobs-into-one-large">
<h1>Packaging smaller parallel jobs into one large<a class="headerlink" href="#packaging-smaller-parallel-jobs-into-one-large" title="Permalink to this headline">Â¶</a></h1>
<p>There are several ways to package smaller parallel jobs into one large
parallel job. The preferred way is to use <span class="xref myst">job arrays</span>.
Here we want to present a more pedestrian alternative which can give a
lot of flexibility.</p>
<p>In this example we imagine that we wish to run a job with 5 MPI job steps
at the same time, each using 4 tasks, thus totalling to 20 tasks:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>

<span class="c1">#SBATCH --account=YourProject  # Substitute with your project name</span>
<span class="c1">#SBATCH --job-name=parallel_tasks_cpu</span>
<span class="c1">#SBATCH --ntasks=20</span>
<span class="c1">#SBATCH --time=0-00:05:00</span>
<span class="c1">#SBATCH --mem-per-cpu=5000M</span>

<span class="c1"># Safety settings</span>
<span class="nb">set</span> -o errexit
<span class="nb">set</span> -o nounset

<span class="c1"># Load MPI module</span>
module --quiet purge
module load OpenMPI/2.1.1-GCC-6.4.0-2.28
module list

<span class="c1"># The set of parallel runs:</span>
srun --ntasks<span class="o">=</span><span class="m">4</span> --exclusive ./my-binary <span class="p">&amp;</span>
srun --ntasks<span class="o">=</span><span class="m">4</span> --exclusive ./my-binary <span class="p">&amp;</span>
srun --ntasks<span class="o">=</span><span class="m">4</span> --exclusive ./my-binary <span class="p">&amp;</span>
srun --ntasks<span class="o">=</span><span class="m">4</span> --exclusive ./my-binary <span class="p">&amp;</span>
srun --ntasks<span class="o">=</span><span class="m">4</span> --exclusive ./my-binary <span class="p">&amp;</span>

<span class="nb">wait</span>
</pre></div>
</div>
<p>Download the script:</p>
<p><a class="reference download internal" download="" href="../../_downloads/d221ad95285cacc0b949d9e3fdd7cc65/parallel_steps_cpu.sh"><code class="xref download docutils literal notranslate"><span class="pre">files/parallel_steps_cpu.sh</span></code></a></p>
<p>This will work with any <span class="xref myst">job type</span> that hands out <em>cpus
and memory</em>, so that one specifies <code class="docutils literal notranslate"><span class="pre">--mem-per-cpu</span></code>.  For instance</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>sbatch --partition=bigmem parallel_steps_cpu.sh
</pre></div>
</div>
<p>For job types that hand out <em>whole nodes</em>, notably the <em>normal</em> jobs
on Fram, one has to do it slightly different.  Here is an example to
run a <code class="docutils literal notranslate"><span class="pre">normal</span></code> job with 8 MPI job steps at the same time, each using
16 tasks, thus totalling 128 tasks:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>

<span class="c1">#SBATCH --account=YourProject  # Substitute with your project name</span>
<span class="c1">#SBATCH --job-name=parallel_tasks_node</span>
<span class="c1">#SBATCH --nodes=4</span>
<span class="c1">#SBATCH --time=00:05:00</span>

<span class="c1"># Safety settings</span>
<span class="nb">set</span> -o errexit
<span class="nb">set</span> -o nounset

<span class="c1"># Load MPI module</span>
module purge
module load OpenMPI/3.1.1-GCC-7.3.0-2.30
module list

<span class="c1"># This is needed for job types that hand out whole nodes:</span>
<span class="nb">export</span> <span class="nv">SLURM_MEM_PER_CPU</span><span class="o">=</span><span class="m">1920</span>

<span class="c1"># The set of parallel runs:</span>
srun --ntasks<span class="o">=</span><span class="m">16</span> --exclusive ./my-binary <span class="p">&amp;</span>
srun --ntasks<span class="o">=</span><span class="m">16</span> --exclusive ./my-binary <span class="p">&amp;</span>
srun --ntasks<span class="o">=</span><span class="m">16</span> --exclusive ./my-binary <span class="p">&amp;</span>
srun --ntasks<span class="o">=</span><span class="m">16</span> --exclusive ./my-binary <span class="p">&amp;</span>
srun --ntasks<span class="o">=</span><span class="m">16</span> --exclusive ./my-binary <span class="p">&amp;</span>
srun --ntasks<span class="o">=</span><span class="m">16</span> --exclusive ./my-binary <span class="p">&amp;</span>
srun --ntasks<span class="o">=</span><span class="m">16</span> --exclusive ./my-binary <span class="p">&amp;</span>
srun --ntasks<span class="o">=</span><span class="m">16</span> --exclusive ./my-binary <span class="p">&amp;</span>

<span class="nb">wait</span>
</pre></div>
</div>
<p>Download the script:</p>
<p><a class="reference download internal" download="" href="../../_downloads/d2023f5c7351a148093c1ae252db63bd/parallel_steps_node.sh"><code class="xref download docutils literal notranslate"><span class="pre">files/parallel_steps_node.sh</span></code></a></p>
<p>For instance (on Fram):</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>sbatch parallel_steps_node.sh
</pre></div>
</div>
<p>A couple of notes:</p>
<ul class="simple">
<li><p>The <code class="docutils literal notranslate"><span class="pre">wait</span></code> command is important - the run script will only continue once
all commands started with <code class="docutils literal notranslate"><span class="pre">&amp;</span></code> have completed.</p></li>
<li><p>It is possible to use <code class="docutils literal notranslate"><span class="pre">mpirun</span></code> instead of <code class="docutils literal notranslate"><span class="pre">srun</span></code>, although <code class="docutils literal notranslate"><span class="pre">srun</span></code> is
recommended for OpenMPI.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">export</span> <span class="pre">SLURM_MEM_PER_CPU=1920</span></code> prior to the <code class="docutils literal notranslate"><span class="pre">srun</span></code> lines is
needed for jobs in the <code class="docutils literal notranslate"><span class="pre">normal</span></code> or <code class="docutils literal notranslate"><span class="pre">optimist</span></code> partitions on Fram, because it
is not possible to specify this to <code class="docutils literal notranslate"><span class="pre">sbatch</span></code> for such jobs.
Alternatively, you can add <code class="docutils literal notranslate"><span class="pre">--mem-per-cpu=1920</span></code> to the <code class="docutils literal notranslate"><span class="pre">srun</span></code>
command lines (this only works with <code class="docutils literal notranslate"><span class="pre">srun</span></code>).  (1920 gives up to 32
tasks per node.  If each task needs more than 1920 MiB per cpu, the
number must be increased (and the number of tasks per node will be
reduced).</p></li>
<li><p>This technique does <strong>not</strong> work with IntelMPI, at least not when using
<code class="docutils literal notranslate"><span class="pre">mpirun</span></code>, which is currently the recommended way of running IntelMPI jobs.</p></li>
</ul>
</div>


           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2020, Sigma2/Metacenter.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>