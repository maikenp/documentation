

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Building scientific software &mdash; Sigma2 documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />

  
  
    <link rel="shortcut icon" href="../_static/sigma2.ico"/>
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Software environment on Betzy" href="betzy.html" />
    <link rel="prev" title="Code development" href="overview.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> Sigma2/Metacenter documentation
          

          
            
            <img src="../_static/logo.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">News</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://opslog.sigma2.no">Latest changes and events</a></li>
<li class="toctree-l1"><a class="reference external" href="https://www.sigma2.no/hardware-status">Hardware live status</a></li>
</ul>
<p class="caption"><span class="caption-text">Getting help</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../getting_help/support_line.html">Support line</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_help/how_to_write_good_support_requests.html">Writing good support requests</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_help/qa-sessions.html">Open Question &amp; Answer Sessions for All Users</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_help/lost_forgotten_password.html">Lost or expiring password</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_help/project_leader_support.html">Project leader support</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_help/advanced_user_support.html">Advanced User Support (AUS)</a></li>
</ul>
<p class="caption"><span class="caption-text">Getting started</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../getting_started/applying_account.html">How do I get an HPC account?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_started/applying_resources.html">Applying for computing and storage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_started/training.html">Training material</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_started/getting_started.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_started/editing_files.html">Editing files</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_started/create_ssh_keys.html">SSH</a></li>
</ul>
<p class="caption"><span class="caption-text">Services</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../nird_archive/user-guide.html">Research data archive</a></li>
<li class="toctree-l1"><a class="reference internal" href="../nird_toolkit/overview.html">NIRD Toolkit</a></li>
<li class="toctree-l1"><a class="reference internal" href="../services/easydmp-user-documentation.html">EasyDMP User Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../getting_help/course_resources.html">CRaaS - Course Resources as a Service</a></li>
</ul>
<p class="caption"><span class="caption-text">High-performance computing</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../hpc_machines/hardware_overview.html">Overview over our machines</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hpc_machines/betzy.html">Betzy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hpc_machines/fram.html">Fram</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hpc_machines/saga.html">Saga</a></li>
<li class="toctree-l1"><a class="reference external" href="https://hpc-uit.readthedocs.io">Stallo</a></li>
<li class="toctree-l1"><a class="reference internal" href="../hpc_machines/migration2metacenter.html">Migration to a Metacenter HPC machine</a></li>
<li class="toctree-l1"><a class="reference internal" href="../jobs/overview.html">Job types and job scripts</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="overview.html">Code development</a><ul class="current">
<li class="toctree-l2 current"><a class="current reference internal" href="#">Building scientific software</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#introduction">Introduction</a></li>
<li class="toctree-l3"><a class="reference internal" href="#compilers">Compilers</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#intel">Intel</a></li>
<li class="toctree-l4"><a class="reference internal" href="#gnu">GNU</a></li>
<li class="toctree-l4"><a class="reference internal" href="#amd-aocc-llvm">AMD AOCC/llvm</a></li>
<li class="toctree-l4"><a class="reference internal" href="#pgi">PGI</a></li>
<li class="toctree-l4"><a class="reference internal" href="#performance-of-compilers">Performance of compilers</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#performance-libraries">Performance libraries</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#intel-mkl">Intel MKL</a></li>
<li class="toctree-l4"><a class="reference internal" href="#amd-aocl">AMD AOCL</a></li>
<li class="toctree-l4"><a class="reference internal" href="#performance">Performance</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#mpi-libraries">MPI libraries</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#openmpi">OpenMPI</a></li>
<li class="toctree-l4"><a class="reference internal" href="#intel-mpi">Intel MPI</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="betzy.html">Software environment on Betzy</a></li>
<li class="toctree-l2"><a class="reference internal" href="compilers.html">Compilers</a></li>
<li class="toctree-l2"><a class="reference internal" href="debugging.html">Debugging</a></li>
<li class="toctree-l2"><a class="reference internal" href="performance.html">Performance Analysis and Tuning</a></li>
<li class="toctree-l2"><a class="reference internal" href="guides.html">Guides</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../computing/tuning-applications.html">Tuning applications</a></li>
</ul>
<p class="caption"><span class="caption-text">Software</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../software/modulescheme.html">Software Module Scheme</a></li>
<li class="toctree-l1"><a class="reference internal" href="../software/installed_software.html">Installed Software</a></li>
<li class="toctree-l1"><a class="reference internal" href="../software/userinstallsw.html">Installing software as user</a></li>
<li class="toctree-l1"><a class="reference internal" href="../software/containers.html">Running Singularity and Docker containers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../software/appguides.html">Application guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../software/licenses.html">Licenses and access policies</a></li>
</ul>
<p class="caption"><span class="caption-text">Files and Storage</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../files_storage/nird.html">NIRD - National Infrastructure for Research Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../files_storage/clusters.html">Storage areas on HPC clusters</a></li>
<li class="toctree-l1"><a class="reference internal" href="../files_storage/backup.html">Backup on Betzy, Fram, Saga, and NIRD</a></li>
<li class="toctree-l1"><a class="reference internal" href="../files_storage/sharing_files.html">Data handling and storage policy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../files_storage/file_transfer.html">File transfer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../files_storage/performance.html">Storage performance tuning</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Sigma2/Metacenter documentation</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="overview.html">Code development</a> &raquo;</li>
        
      <li>Building scientific software</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            
              <a href="https://github.com/UNINETTSigma2/documentation/blob/master/code_development/building.md" class="fa fa-github"> Edit on GitHub</a>
            
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="building-scientific-software">
<h1>Building scientific software<a class="headerlink" href="#building-scientific-software" title="Permalink to this headline">¶</a></h1>
<div class="section" id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>This is just a quick short guide on the topic. For more in depth documentation please
check out the PRACE Best Practice Guides at:
https://prace-ri.eu/training-support/best-practice-guides/</p>
<p>Most relevant for Betzy :
https://prace-ri.eu/training-support/best-practice-guides/best-practice-guide-amd-epyc/
and an update covering AMD Rome named  “Best Practice Guide Modern Processors”
soon to be published.</p>
</div>
<div class="section" id="compilers">
<h2>Compilers<a class="headerlink" href="#compilers" title="Permalink to this headline">¶</a></h2>
<div class="section" id="intel">
<h3>Intel<a class="headerlink" href="#intel" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id1">
<h4>Introduction<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h4>
<p>The Intel compiler suite is supported on all Sigma2 systems. On the
systems Saga and Fram the processors are from Intel while the
processors on Betzy are from AMD. As the Intel compiler is primarily
compiler written fro the Intel processors there are some minor issues
when using it to build core for the AMD processors.</p>
</div>
<div class="section" id="documentation">
<h4>Documentation<a class="headerlink" href="#documentation" title="Permalink to this headline">¶</a></h4>
<p>The documentation of the Intel compiler are found at
<a class="reference external" href="https://software.intel.com/content/www/us/en/develop/tools/compilers.html">Intel compiler</a>
The web site is comprehensive and some browsing are required to find the needed documents.
Most users want to review the reference manual.</p>
<ul class="simple">
<li><p><a class="reference external" href="https://software.intel.com/content/www/us/en/develop/documentation/cpp-compiler-developer-guide-and-reference/top.html">C/C++ reference</a></p></li>
<li><p><a class="reference external" href="https://software.intel.com/content/www/us/en/develop/tools/compilers/fortran-compilers/documentation.html">Fortran reference</a></p></li>
</ul>
</div>
<div class="section" id="compiler-flags">
<h4>Compiler flags<a class="headerlink" href="#compiler-flags" title="Permalink to this headline">¶</a></h4>
<p>The single most common question requested is a set of suggested
compiler flags. The Intel development team have already selected a
very good set of flags and just a simple <em>-O3</em> flag will provide quite
good choice. The compiler comes with a set of default optimisation flags already
set. Just invoking the compiler without any such flags will generate reasonbly good code.</p>
<p>The flag for OpenMP is very often needed : <em>-qopenmp</em> and must be used in both compiling a linking.</p>
<p>To ask the compiler generate optimised code have a huge impact in performance.
The following graph show the observed speed using the
<a class="reference external" href="https://en.wikipedia.org/wiki/NAS_Parallel_Benchmarks">NASA NPB MPI</a> benchmarks built
using the Intel compiler and run using OpenMPI at 64 ranks.</p>
<p><img alt="Optimisation gain" src="../_images/optgain.png" /></p>
<p>The benefit of selecting optimisation flags is obvious. The effect of vectorisation is
less pronounced with these benchmarks which are extracts from real applications and running with datasets of
serious size. The compiler can recognise some type of code and generate excellent code, often related
to cache and TLB issues. Just looking at the generated code will not tell what the compiler actually did.
See an extreme case with matrix multiplication below. Tuning tools can help looking for cache and
<a class="reference external" href="https://en.wikipedia.org/wiki/Translation_lookaside_buffer">TLB</a> issues.</p>
<p>Some optimisation flags are a bit more tricky. As all processors
support AVX2 this can always be used. A suggested list set of flags
than be tried might include:</p>
<ul class="simple">
<li><p>-O3</p></li>
<li><p>-O3 -xHost</p></li>
<li><p>-Ofast</p></li>
<li><p>-O3 -march=core-avx</p></li>
<li><p>-O3 -xavx</p></li>
<li><p>-O3 -xavx2</p></li>
<li><p>-O3 -xcore-avx2</p></li>
</ul>
<p>The flags above have been tested and yield good results. On Betzy the
flags involving <em>-xavx</em>, <em>-xavx2</em> and <em>-xcore-avx2</em> can cause
problems. As the -x prefix implies it will only generate code for a
processor supporting AVX and AVX2. Intel has implemented a run time
processor check for any program compiled with these flags, which will result
in a message like this:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Please verify that both the operating system and the processor support
Intel(R) X87, CMOV, MMX, FXSAVE, SSE, SSE2, SSE3, SSSE3, SSE4_1, SSE4_2,
MOVBE, POPCNT, AVX, F16C, FMA, BMI, LZCNT and AVX2 instructions.
</pre></div>
</div>
<p>This only apply to the main routine.  If the main() function is not compiled
with <code class="docutils literal notranslate"><span class="pre">-xavx</span></code>/<code class="docutils literal notranslate"><span class="pre">-xavx2</span></code> flags the test is not inserted and performance
is as expected.</p>
<table class="colwidths-auto docutils align-default">
<thead>
<tr class="row-odd"><th class="text-align:center head"><p>Vectorisation flag</p></th>
<th class="text-align:center head"><p>Single core performance</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td class="text-align:center"><p>-O3</p></td>
<td class="text-align:center"><p>4.33 Gflops/sec</p></td>
</tr>
<tr class="row-odd"><td class="text-align:center"><p>-O3 -march=core-avx2</p></td>
<td class="text-align:center"><p>4.79 Gflops/sec</p></td>
</tr>
<tr class="row-even"><td class="text-align:center"><p>-O3 -xavx</p></td>
<td class="text-align:center"><p>17.97 Gflops/sec</p></td>
</tr>
<tr class="row-odd"><td class="text-align:center"><p>-O3 -xavx2</p></td>
<td class="text-align:center"><p>26.39 Gflops/sec</p></td>
</tr>
<tr class="row-even"><td class="text-align:center"><p>-O3 -xcore-avx2</p></td>
<td class="text-align:center"><p>26.38 Gflops/sec</p></td>
</tr>
</tbody>
</table>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>The <code class="docutils literal notranslate"><span class="pre">-xavx2</span></code> flag is quite intrusive, it’s building only AVX2 vector
instructions and if the processor does not support it, you’ll get illegal
instruction.</p>
</div>
<p>The example above is a best case where the Intel compiler manage to analyse
the code and apply special optimisation for matrix multiplication. Checking the
code show that is does not call external functions like the matmul in MKL.</p>
<p>For codes that are more realistic and closer to scientific codes like the NPB benchmarks the effect
is much smaller. In some cases there are still a significant gain by using the <code class="docutils literal notranslate"><span class="pre">-xAVX2</span></code>, the figure
below illustrate this.</p>
<p><img alt="xAVX2 gain" src="../_images/xAVX2gain.png" /></p>
<p>There are a large range of other flags, and while the web
documentation is very good it can be overwhelming. A simple trick is
to issue the following command <code class="docutils literal notranslate"><span class="pre">icc</span> <span class="pre">-help</span> <span class="pre">&gt;</span> <span class="pre">icc.hpl</span></code> and open the file
in an editor and search and read relevant paragraphs. Except from
language specific flags most of the flags are similar for C/C++ and
Fortran.</p>
<p>The flags related to optimisation reports can be useful, <em>-qopt-report</em>.
To generate a nice optimisation report some of the following flags could
be used.</p>
<ul class="simple">
<li><p>-qopt-report-help</p></li>
<li><p>-qopt-report=1 (any number from 1 through 5 are valid, 0 turn it off)</p></li>
<li><p>-qopt-report-file=&lt;file.opt.txt&gt;</p></li>
<li><p>-qopt-report-annotate</p></li>
</ul>
<p>An example is : <code class="docutils literal notranslate"><span class="pre">-qopt-report=5</span> <span class="pre">-O3</span> <span class="pre">-xavx2</span> <span class="pre">-g</span> <span class="pre">-S</span></code> which will generate
a comprehensive report and a file containing the generated
code. Reviewing this report and the code can be of great help in cases
where the compiler fail to optimise as expected.</p>
</div>
</div>
<div class="section" id="gnu">
<h3>GNU<a class="headerlink" href="#gnu" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id2">
<h4>Introduction<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h4>
<p>GNU compilers are an integral part of the Linux distribution. However,
the versions of the compilers that comes with the distribution are
generally not the newest version. Look for modules that supply a more
recent version. The compiles support C/C++ and Fortran.</p>
</div>
<div class="section" id="id3">
<h4>Documentation<a class="headerlink" href="#id3" title="Permalink to this headline">¶</a></h4>
<p>The compilers have good man pages covering most of what is commonly needed. More deep
documentation is found here : https://gcc.gnu.org/onlinedocs/ .</p>
</div>
<div class="section" id="id4">
<h4>Compiler flags<a class="headerlink" href="#id4" title="Permalink to this headline">¶</a></h4>
<p>The default settings of gcc/gfortran are not optimal for performance. A set of optimising flags are needed. The flag for OpenMP is <em>-fopenmp</em>.</p>
<p>There a lot of optimisers available, a list can be generated using the command
<code class="docutils literal notranslate"><span class="pre">gcc</span> <span class="pre">--help=optimizers</span></code></p>
<p>Some set of flags for optimisation include :</p>
<ul class="simple">
<li><p>-O2 (often use for only memory intensive applications)</p></li>
<li><p>-O3</p></li>
<li><p>-O3 -mfma -mavx2</p></li>
<li><p>-O3 -march=znver2 -mtune=znver2 (for AMD)</p></li>
<li><p>-O3 -march=skylake-avx512  (for Intel Skylake)</p></li>
</ul>
</div>
</div>
<div class="section" id="amd-aocc-llvm">
<h3>AMD AOCC/llvm<a class="headerlink" href="#amd-aocc-llvm" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id5">
<h4>Introduction<a class="headerlink" href="#id5" title="Permalink to this headline">¶</a></h4>
<p>AMD support the development of compilers based on llvm. The Software development kit can be found at : https://developer.amd.com/tools-and-sdks/ .
C/C++ and Fortran are supported.</p>
</div>
<div class="section" id="id6">
<h4>Documentation<a class="headerlink" href="#id6" title="Permalink to this headline">¶</a></h4>
<p>The AMD documentation is limited. Documentation can be found at the AMD developer
web site given above.</p>
</div>
<div class="section" id="id7">
<h4>Compiler flags<a class="headerlink" href="#id7" title="Permalink to this headline">¶</a></h4>
<p>The llvm compiler show a huge range of compiler flags, the AMD
documentation provide a nice subset of relevant flags. The flag for
OpenMP is <em>-fopenmp</em>. A suggested flags to try is given below.</p>
<ul class="simple">
<li><p>-O3</p></li>
<li><p>-Ofast</p></li>
<li><p>-Ofast -march=znver2 -mtune=znver2  (for AMD)</p></li>
<li><p>-Ofast -march=znver2 -mavx2 -m3dnow (for AMD)</p></li>
</ul>
</div>
</div>
<div class="section" id="pgi">
<h3>PGI<a class="headerlink" href="#pgi" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id8">
<h4>Introduction<a class="headerlink" href="#id8" title="Permalink to this headline">¶</a></h4>
<p>Portland Group compiler, known as PGI compiler is now a part of NVIDIA. The PGI web page
is still available : https://www.pgroup.com/index.htm .</p>
</div>
<div class="section" id="id9">
<h4>Documentation<a class="headerlink" href="#id9" title="Permalink to this headline">¶</a></h4>
<p>Documentation can be found at : https://www.pgroup.com/resources/docs/20.4/x86/index.htm</p>
</div>
<div class="section" id="id10">
<h4>Compiler flags<a class="headerlink" href="#id10" title="Permalink to this headline">¶</a></h4>
<p>Please review the documentation for an updated list of the suggested compiler flags.</p>
<p>A set of suggested flags are :</p>
<ul class="simple">
<li><p>-O3 -tp zen -Mvect=simd -Mcache_align -Mprefetch -Munroll  (for AMD)</p></li>
</ul>
</div>
</div>
<div class="section" id="performance-of-compilers">
<h3>Performance of compilers<a class="headerlink" href="#performance-of-compilers" title="Permalink to this headline">¶</a></h3>
<p>A test using the well known reference implementation of matrix matrix
(<a class="reference external" href="http://www.netlib.org/lapack/explore-html/d7/d2b/dgemm_8f_source.html">dgemm</a>)
multiplication is used for a simple test of the different compilers.</p>
<table class="colwidths-auto docutils align-default">
<thead>
<tr class="row-odd"><th class="text-align:left head"><p>Compiler</p></th>
<th class="text-align:center head"><p>Flags</p></th>
<th class="text-align:center head"><p>Performance</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td class="text-align:left"><p>GNU gfortran</p></td>
<td class="text-align:center"><p>-O3 -march=znver2 -mtune=znver2</p></td>
<td class="text-align:center"><p>4.79 Gflops/s</p></td>
</tr>
<tr class="row-odd"><td class="text-align:left"><p>AOCC flang</p></td>
<td class="text-align:center"><p>-Ofast -march=znver2 -mavx2 -m3dnow</p></td>
<td class="text-align:center"><p>5.21 Gflops/s</p></td>
</tr>
<tr class="row-even"><td class="text-align:left"><p>Intel ifort</p></td>
<td class="text-align:center"><p>-O3 -xavx2</p></td>
<td class="text-align:center"><p>26.39 Gflops/s</p></td>
</tr>
</tbody>
</table>
<p>The Intel Fortran compiler do a remarkable job with this nested loop problem.
As we have seen above the matrix matrix multiplication is a special case. For more
realistic examples the performace is more comparable.</p>
<p><img alt="Compiler performance" src="../_images/compiler-perf.png" /></p>
<p>It turns out that for the EP benchmark (Generate independent Gaussian random variates using the Marsaglia polar method)
the Intel compiler manage to do something smart.</p>
</div>
</div>
<div class="section" id="performance-libraries">
<h2>Performance libraries<a class="headerlink" href="#performance-libraries" title="Permalink to this headline">¶</a></h2>
<div class="section" id="intel-mkl">
<h3>Intel MKL<a class="headerlink" href="#intel-mkl" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id11">
<h4>Introduction<a class="headerlink" href="#id11" title="Permalink to this headline">¶</a></h4>
<p>The Intel Math Kernel Library comes with the compiler suite and is well known as
high performance library. It comes in both sequential and multi threaded functions
and is know for its very high performance.</p>
<p>MKL have wrappers for FFTW so no rewrite is needed to link any applications using
FFTW with MKL. Both Include files and library functions are provided.</p>
<p>When using the Intel compiler the compiling and linking is very simple, most
of the times is enough to just add <em>-mkl</em>. Adding <em>=sequential</em> or <em>=parallel</em>.</p>
<p>When using MKL with the GNU compilers some more work is often needed.
An example can provide some hints:
<code class="docutils literal notranslate"><span class="pre">-L$MKLROOT/lib/intel64</span> <span class="pre">-lmkl_gnu_thread</span> <span class="pre">-lmkl_avx2</span> <span class="pre">-lmkl_core</span> <span class="pre">-lmkl_rt</span></code>
The variable <em>MKLROOT</em> is set when the Intel module is loaded.</p>
<p>The following command can be of help when encounter missing symbols:
<code class="docutils literal notranslate"><span class="pre">nm</span> <span class="pre">-A</span> <span class="pre">$MKLROOT/lib/intel64/*</span> <span class="pre">|</span> <span class="pre">grep</span> <span class="pre">&lt;missing</span> <span class="pre">symbol&gt;</span></code>
Look for symbols with <em>T</em> (T means text,global - e.g. it’s available, U means undefined).</p>
</div>
<div class="section" id="forcing-mkl-to-use-best-performing-routines">
<h4>Forcing MKL to use best performing routines<a class="headerlink" href="#forcing-mkl-to-use-best-performing-routines" title="Permalink to this headline">¶</a></h4>
<p>MKL issue a run time test to check for genuine Intel processor. If this test fail it will select a generic x86-64 set of routines yielding
inferior performance. This is well documented in <a class="reference external" href="https://en.wikipedia.org/wiki/Math_Kernel_Library">Wikipedia</a> and remedies in
<a class="reference external" href="https://danieldk.eu/Posts/2020-08-31-MKL-Zen.html">Intel MKL on AMD Zen</a>.</p>
<p>Research have discovered that MKL call a function called <em>mkl_serv_intel_cpu_true()</em> to check the current CPU. If a genuine Intel processor is
found it simply return 1. The solution is simply to override this function by writing a dummy functions which always return 1 and place this
early in the search path. The function is simply:</p>
<div class="highlight-c: notranslate"><div class="highlight"><pre><span></span>int mkl_serv_intel_cpu_true() {
  return 1;
}
</pre></div>
</div>
<p>Compiling this file into a shared library using the following command:
<code class="docutils literal notranslate"><span class="pre">gcc</span> <span class="pre">-shared</span> <span class="pre">-fPIC</span> <span class="pre">-o</span> <span class="pre">libfakeintel.so</span> <span class="pre">fakeintel.c</span></code></p>
<p>To put the new shared library first in the search path we can use a preload environment variable:
<code class="docutils literal notranslate"><span class="pre">export</span> <span class="pre">LD_PRELOAD=&lt;path</span> <span class="pre">to</span> <span class="pre">lib&gt;</span></code>
A suggestion is to place the new shared library in <code class="docutils literal notranslate"><span class="pre">$HOME/lib64</span></code> and using
<code class="docutils literal notranslate"><span class="pre">export</span> <span class="pre">LD_PRELOAD=$HOME/lib64/libfakeintel.so</span></code> to insert the fake test function.</p>
<p>In addition the envionment variable <em>MKL_ENABLE_INSTRUCTIONS</em> can also have a significant effect.
Setting the variable to AVX2 is adviced. Just changing it to AVX have a significant negative impact.</p>
<p>For performance impact and more about running software with MKL please see
<a class="reference internal" href="../jobs/running-scientific-software.html#running-scientific-software"><span class="std std-ref">Running scientific software</span></a>.</p>
</div>
<div class="section" id="id12">
<h4>Documentation<a class="headerlink" href="#id12" title="Permalink to this headline">¶</a></h4>
<p>Online documentation can be found at :  https://software.intel.com/content/www/us/en/develop/documentation/mkl-linux-developer-guide/top.html</p>
<p>There is a link line helper available : https://software.intel.com/content/www/us/en/develop/articles/intel-mkl-link-line-advisor.html , this can often be of help.</p>
</div>
</div>
<div class="section" id="amd-aocl">
<h3>AMD AOCL<a class="headerlink" href="#amd-aocl" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id13">
<h4>Introduction<a class="headerlink" href="#id13" title="Permalink to this headline">¶</a></h4>
<p>The AMD performance library provide a set of library functions optimised for the AMD processor.
The web page is : https://developer.amd.com/amd-aocl/ .</p>
</div>
<div class="section" id="id14">
<h4>Documentation<a class="headerlink" href="#id14" title="Permalink to this headline">¶</a></h4>
<p>Documentation can be found at https://developer.amd.com/amd-aocl/ .</p>
</div>
</div>
<div class="section" id="performance">
<h3>Performance<a class="headerlink" href="#performance" title="Permalink to this headline">¶</a></h3>
<p>The same test using matrix matrix multiplication, Level 3 BLAS
function dgemm is used to test single core performance of the
libraries. The tests are run on a single node using a single core on
Betzy.</p>
<table class="colwidths-auto docutils align-default">
<thead>
<tr class="row-odd"><th class="text-align:left head"><p>Library</p></th>
<th class="text-align:center head"><p>Link line</p></th>
<th class="text-align:center head"><p>Performance</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td class="text-align:left"><p>AOCL</p></td>
<td class="text-align:center"><p><code class="docutils literal notranslate"><span class="pre">gfortran</span> <span class="pre">-o</span> <span class="pre">dgemm-test.x</span> <span class="pre">-O3</span> <span class="pre">dgemm-test.f90</span> <span class="pre">-L$LIB</span> <span class="pre">-lblis</span></code></p></td>
<td class="text-align:center"><p>50.13 Gflops/s</p></td>
</tr>
<tr class="row-odd"><td class="text-align:left"><p>AOCL</p></td>
<td class="text-align:center"><p><code class="docutils literal notranslate"><span class="pre">flang</span> <span class="pre">-o</span> <span class="pre">dgemm-test.x</span> <span class="pre">-O3</span> <span class="pre">dgemm-test.f90</span> <span class="pre">-L$LIB</span> <span class="pre">-lblis</span></code></p></td>
<td class="text-align:center"><p>50.13 Gflops/s</p></td>
</tr>
<tr class="row-even"><td class="text-align:left"><p>MKL</p></td>
<td class="text-align:center"><p><code class="docutils literal notranslate"><span class="pre">ifort</span> <span class="pre">-o</span> <span class="pre">dgemm-test.x</span> <span class="pre">-O3</span> <span class="pre">dgemm-test.f90</span> <span class="pre">-mkl=sequential</span></code></p></td>
<td class="text-align:center"><p>51.53 Gflops/s</p></td>
</tr>
</tbody>
</table>
<p>Using the MLK library with AMD is straightforward. In order to get MKL
to select the correct AVX2 enabled routine a flag need to be set,
use : <code class="docutils literal notranslate"><span class="pre">export</span> <span class="pre">MKL_DEBUG_CPU_TYPE=5</span></code>.  This flag is no longer honoured
in the 2020 version of the MKL. Without support for this flag the
performance is significantly lower, one test showed about 48 Gflops/s.
For more about MKL performance and AMD see above about
“Forcing MKL to use best performing routines”.</p>
<p>At 50 Gflops/s per core the aggregate number is 6.4 Tflops/s quite a
bit more than what’s expected from these nodes. This is a nice example
of clock boost when using only a few cores, or in this case only one.</p>
</div>
</div>
<div class="section" id="mpi-libraries">
<h2>MPI libraries<a class="headerlink" href="#mpi-libraries" title="Permalink to this headline">¶</a></h2>
<div class="section" id="openmpi">
<h3>OpenMPI<a class="headerlink" href="#openmpi" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id15">
<h4>Introduction<a class="headerlink" href="#id15" title="Permalink to this headline">¶</a></h4>
<p>The OpenMPI library are based on the old LAM MPI from Ohio
Supercomputing Center. This one of the most widely used MPI
implementations today. The web site is : https://www.open-mpi.org/ .</p>
<p>OpenMPI is supported on all the Sigma2 systems, with versions for both
GNU and Intel compilers, and in some cases some support for other
compilers.</p>
</div>
<div class="section" id="usage">
<h4>Usage<a class="headerlink" href="#usage" title="Permalink to this headline">¶</a></h4>
<p>The compiler wrappers hiding the include and link environment are called:</p>
<ul class="simple">
<li><p>mpicc for C</p></li>
<li><p>mpicxx for C++</p></li>
<li><p>mpif90 for Fortran</p></li>
<li><p>mpff77 for Fortran</p></li>
</ul>
<p>In practice both mpif90 and mpif77 points to the same Fortran compiler. A quick check for
compiler versions is <code class="docutils literal notranslate"><span class="pre">mpif90</span> <span class="pre">-v</span></code>.</p>
<p>Compiler flags are propagated to the underlaying compiler.</p>
<p>To run programs the launched application mpirun is used (SLURM srun is
an option also). There are a range of options to OpenMPI’s mpirun of
which <code class="docutils literal notranslate"><span class="pre">--bind-to</span></code> and <code class="docutils literal notranslate"><span class="pre">--map-by</span></code> a the most important when running on
the Sigma2 systems using SLURM as the queue system set the number of
ranks and other run time parameters like list of hosts etc. This is normal
for MPI libraries built and installed with SLURM support.</p>
</div>
</div>
<div class="section" id="intel-mpi">
<h3>Intel MPI<a class="headerlink" href="#intel-mpi" title="Permalink to this headline">¶</a></h3>
<div class="section" id="id16">
<h4>Introduction<a class="headerlink" href="#id16" title="Permalink to this headline">¶</a></h4>
<p>The Intel MPI is part of the Intel compiler suite and is a widely used MPI implementation.
More information is found on-line at : https://software.intel.com/content/www/us/en/develop/tools/mpi-library.html .</p>
<p>Intel MPI is supported on all Sigma2 systems, but mostly for use with
the Intel compiler, it can however, to some extent be used with
GNU. The support is present.</p>
</div>
<div class="section" id="id17">
<h4>Usage<a class="headerlink" href="#id17" title="Permalink to this headline">¶</a></h4>
<p>The compiler wrappers have different naming then many other MPI implementations.</p>
<ul class="simple">
<li><p>mpiicc for C</p></li>
<li><p>mpiicpc for C++</p></li>
<li><p>mpiifort for Fortran</p></li>
<li><p>mpicc  GNU C</p></li>
<li><p>mpigcc GNU C</p></li>
<li><p>mpicxx GNU C++</p></li>
<li><p>mpifc GNU Fortran</p></li>
</ul>
<p>There are a lot of environment variables to be used with Intel MPI, they all start with <em>I_MPI</em></p>
<ul class="simple">
<li><p>I_MPI_PIN</p></li>
<li><p>I_MPI_PIN_DOMAIN</p></li>
<li><p>I_MPI_PIN_PROCESSOR_EXCLUDE_LIST</p></li>
</ul>
<p>The variable <em>I_MPI_PIN_DOMAIN</em> is good when running hybrid codes,
setting it to the number of threads per rank will help the launcher to
place the ranks correct.
Setting <em>I_MPI_PIN_PROCESSOR_EXCLUDE_LIST=128-255</em> will make sure only
physical cores 0-127 are used for MPI ranks. This ensures that no two
ranks share the same physical core.</p>
<p>As with any of these variable and other please review the
documentation pointed to above and do some testing yourself before
employing in large production scale.</p>
<p>Running applications with Intel MPI is just like a simple as for
OpenMPI as Intel MPI also has support for SLURM. Just <code class="docutils literal notranslate"><span class="pre">mpirun</span> <span class="pre">./a.out</span></code>
is normally enough.</p>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="betzy.html" class="btn btn-neutral float-right" title="Software environment on Betzy" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="overview.html" class="btn btn-neutral float-left" title="Code development" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2020, Sigma2/Metacenter.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>